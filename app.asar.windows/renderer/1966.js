"use strict";(global.webpackChunkxmind_vana=global.webpackChunkxmind_vana||[]).push([[1966,623],{40623:(e,t,i)=>{var n;i.d(t,{v:()=>n,w:()=>o}),function(e){e.LOGICRIGHT="org.xmind.ui.logic.right",e.LOGICLEFT="org.xmind.ui.logic.left",e.TREERIGHT="org.xmind.ui.tree.right",e.TREELEFT="org.xmind.ui.tree.left",e.TREESIDED="org.xmind.ui.timeline.vertical",e.ORGCHARTDOWN="org.xmind.ui.org-chart.down",e.ORGCHARTUP="org.xmind.ui.org-chart.up",e.MAPCLOCKWISE="org.xmind.ui.map.clockwise",e.MAPANTICLOCKWISE="org.xmind.ui.map.anticlockwise",e.MAP="org.xmind.ui.map",e.MAPUNBALANCED="org.xmind.ui.map.unbalanced",e.MAPFLOATING="org.xmind.ui.map.floating",e.MAPFLOATINGCLOCKWISE="org.xmind.ui.map.floating.clockwise",e.MAPFLOATINGANTICLOCKWISE="org.xmind.ui.map.floating.anticlockwise",e.TIMELINETHROUGHVERTICAL="org.xmind.ui.timeline.through.vertical",e.TIMELINESIDEDHORIZONTAL="org.xmind.ui.timeline.sided.horizontal",e.TIMELINEHORIZONTAL="org.xmind.ui.timeline.horizontal",e.FISHBONELEFTHEADED="org.xmind.ui.fishbone.leftHeaded",e.LEFTHEADTOPBONE="org.xmind.ui.fishbone.structure.lefthead.topbone",e.LEFTHEADBOTTOMBONE="org.xmind.ui.fishbone.structure.lefthead.bottombone",e.FISHBONERIGHTHEADED="org.xmind.ui.fishbone.rightHeaded",e.RIGHTHEADTOPBONE="org.xmind.ui.fishbone.structure.righthead.topbone",e.RIGHTHEADBOTTOMBONE="org.xmind.ui.fishbone.structure.righthead.bottombone",e.SPREADSHEET="org.xmind.ui.spreadsheet",e.COLUMNSPREADSHEET="org.xmind.ui.spreadsheet.column",e.TREETABLE="org.xmind.ui.treetable",e.TOPTITLETREETABLE="org.xmind.ui.treetable.toptitle",e.SPREADSHEETROW="org.xmind.ui.structure.spreadsheet.row",e.SPREADSHEETCOLUMN="org.xmind.ui.structure.column.spreadsheet",e.FISHBONELEFTHEADTOP="org.xmind.ui.fishbone.leftHeaded.top",e.FISHBONELEFTHEADBOTTOM="org.xmind.ui.fishbone.leftHeaded.bottom",e.FISHBONERIGHTHEADTOP="org.xmind.ui.fishbone.rightHeaded.top",e.FISHBONERIGHTHEADBOTTOM="org.xmind.ui.fishbone.rightHeaded.bottom",e.TIMELINEHORIZONTALUP="org.xmind.ui.timeline.horizontal.up",e.TIMELINEHORIZONTALDOWN="org.xmind.ui.timeline.horizontal.down",e.LOGICCHARTRIGHT="org.xmind.ui.logic-chart.right",e.LOGICCHARTLEFT="org.xmind.ui.logic-chart.left",e.BRACERIGHT="org.xmind.ui.brace.right",e.BRACELEFT="org.xmind.ui.brace.left",e.TIMELINEVERTICAL="org.xmind.ui.timeline.vertical"}(n||(n={}));const o={[n.MAPUNBALANCED]:"map-unbalance",[n.MAPCLOCKWISE]:"map-clockwise",[n.LOGICRIGHT]:"logic-right",[n.LOGICLEFT]:"logic-left",[n.BRACERIGHT]:"brace-right",[n.BRACELEFT]:"brace-left",[n.TREERIGHT]:"tree-right",[n.TREELEFT]:"tree-left",[n.ORGCHARTDOWN]:"org-down",[n.ORGCHARTUP]:"org-up",[n.FISHBONELEFTHEADED]:"fishbone-left",[n.FISHBONERIGHTHEADED]:"fishbone-right",[n.TIMELINEHORIZONTAL]:"timeline-horizontal",[n.TIMELINEVERTICAL]:"timeline-vertical",[n.TIMELINETHROUGHVERTICAL]:"timeline-through-vertical",[n.TIMELINESIDEDHORIZONTAL]:"timeline-sided-horizontal",[n.SPREADSHEET]:"matrix-row",[n.COLUMNSPREADSHEET]:"matrix-column",[n.TOPTITLETREETABLE]:"tree-table-column",[n.TREETABLE]:"tree-table-row"}},11966:(e,t,i)=>{i.r(t),i.d(t,{exportBranchAsPNG:()=>A,exportBranchAsSVG:()=>R,exportImage:()=>W});var n=i(54856),o=i(96829),r=i(84374),a=i(90435),d=i(18621),l=i(71017),s=i.n(l),c=i(72298),u=i(67657),h=i(41809),m=i(78152),g=i(5893),p=i(1171),v=i(69361),f=i(94593),E=i(86633),T=i(13382),y=i(95246),I=i(63111),S=function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function a(e){try{l(n.next(e))}catch(e){r(e)}}function d(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,d)}l((n=n.apply(e,t||[])).next())}))};const x=(0,E.ZP)("export:png"),A=()=>S(void 0,void 0,void 0,(function*(){yield(0,v.Ae)("png");const{activeSheetId:e,selection:t,document:i}=(0,r.nZ)(),{status:n}=(0,m.Yh)(),o=t.value.modelIds;if(0===o.length)return;const a=(0,v.nv)(o),d=n===I.wi.VALID,l=new v.Y8,s=yield Promise.all(a.map((t=>S(void 0,void 0,void 0,(function*(){const n=i.value.query({id:t}).asTopic().title;return{fileName:l.makeSafeName(n),fileData:yield b(e.value,{hasWatermark:!d,transparent:!1},t)}})))));if(yield(0,v.Gm)(),1===s.length){const{fileData:e,fileName:t}=s[0];L(e,t)}else s.length>1&&O(s)})),b=(e,{hasWatermark:t=!1,transparent:i=!1,scale:n=1},o)=>S(void 0,void 0,void 0,(function*(){const{getSheetViewer:a}=(0,r.nZ)(),d=a(e),l=yield(0,v.J2)((()=>d.exportSVGElement({padding:{top:50,left:50,right:50,bottom:t?120:50},opaqueBackground:!i,hasWatermark:t,scopeTopicId:o})),x);if(!l)return;const s={data:l,scale:n,width:Number(l.getAttribute("width"))*n,height:Number(l.getAttribute("height"))*n};return yield w(s)})),L=(e,t)=>S(void 0,void 0,void 0,(function*(){const i=yield(0,T.ZZ)({title:"Export",properties:["createDirectory"],suggestPath:{suggestedName:t},filters:[{name:"PNG",extensions:["png"]}]});i&&(yield f.Z.writeFile(i,Buffer.from(e.slice(22),"base64")),(0,m.Rg)().addRateMasValue(1),c.shell.openPath(i))})),O=e=>S(void 0,void 0,void 0,(function*(){const{T:t}=(0,m.JE)(),i=yield(0,T.eq)({folderName:null,dialogOptions:{buttonLabel:t("Save"),properties:["openDirectory","createDirectory"]}});if(!i)return;const n=(0,p.F)().title||"",o=s().join(i,n);f.Z.ensureDirSync(o),yield Promise.all(e.map((e=>{const{fileData:t,fileName:i}=e,n=s().join(o,i+".png");return(0,v.yS)(n,Buffer.from(t.slice(22),"base64"))}))),c.shell.openPath(o)})),w=e=>S(void 0,void 0,void 0,(function*(){const t=(0,y.gP)(),i=25.4/t.x,n=25.4/t.y,r=e.width,a=e.height,d={orientation:r>a?"landscape":"portrait",pageSize:{x:Math.max(Math.round(Math.min(r,a)*i)+1,21),y:Math.round(Math.max(r,a)*n)+1}},l=d.pageSize,s=d.orientation,c="portrait"===s?l.x:l.y,u="portrait"===s?l.y:l.x,m={x:Math.round(c*t.x/25.4),y:Math.round(u*t.y/25.4)},g="print_"+(0,o.hb)(),p=e.data;p.setAttribute("width",m.x.toString()),p.setAttribute("height",m.y.toString()),p.setAttribute("id",g),p.style.display="",p.classList.add("print-el"),p.setAttribute("width",e.width.toString()),p.setAttribute("height",e.height.toString());const f=(new XMLSerializer).serializeToString(p),E=new Blob([f],{type:"image/svg+xml"}),T=yield new Promise((e=>{const t=new FileReader;t.onload=()=>{e(t.result)},t.readAsDataURL(E)}));let I=yield(0,v.qM)(T,2,"string");const S=N();return S>1&&(I=(0,h.Hv)(I,72*S)),I})),N=()=>{const e=u.screen.getAllDisplays().map((e=>e.scaleFactor));return Math.max.apply(null,e)};var H=function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function a(e){try{l(n.next(e))}catch(e){r(e)}}function d(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,d)}l((n=n.apply(e,t||[])).next())}))};const R=()=>H(void 0,void 0,void 0,(function*(){const{T:e}=(0,m.JE)(),{selection:t,document:i,activeSheet:n}=(0,r.nZ)(),{title:o,id:a}=n.value,d=t.value.modelIds;if(0===d.length)return;const l=(0,v.nv)(d),u=new v.Y8,h=yield Promise.all(l.map((e=>H(void 0,void 0,void 0,(function*(){var t;const n=yield D(a,!1,e),r=i.value.query({id:e}).asTopic().title;return{fileName:null!==(t=u.makeSafeName(r))&&void 0!==t?t:o,fileData:n}})))));if(1===h.length){const e=h[0],{fileData:t,fileName:i}=e,n=yield(0,T.ZZ)({title:"Export",suggestPath:{suggestedName:i},properties:["createDirectory"],filters:[{name:"SVG",extensions:["svg"]}]});if(!n)return;yield(0,v.yS)(n,t),(0,m.Rg)().addRateMasValue(1),c.shell.showItemInFolder(n)}else if(h.length>1){const t=yield(0,T.eq)({folderName:o,dialogOptions:{buttonLabel:e("Save"),properties:["openDirectory","createDirectory"]}});if(!t)return;f.Z.existsSync(t)||f.Z.ensureDir(t),Promise.all(h.map((({fileData:e,fileName:i})=>{const n=s().join(t,i+".svg");return(0,v.yS)(n,e)}))).then((()=>c.shell.openPath(t)))}})),D=(e,t,i)=>H(void 0,void 0,void 0,(function*(){const{sheets:n,getSheetViewer:o}=(0,r.nZ)(),a=o(n.value.find((t=>t.id===e)).id),l=Date.now();(0,d.L9)({eventCategory:"export",eventAction:"durationExportSvg",eventValue:Date.now()-l});return(yield a.exportSVGImage({padding:{left:50,right:50,top:50,bottom:50},opaqueBackground:!t,scopeTopicId:i})).svg}));var P=i(40623),C=function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function a(e){try{l(n.next(e))}catch(e){r(e)}}function d(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,d)}l((n=n.apply(e,t||[])).next())}))};const B=({sheetId:e,hasWatermark:t,opaqueBackground:i,disableEmbedFonts:n})=>C(void 0,void 0,void 0,(function*(){const o=[],{getSheetViewer:a,sheets:d}=(0,r.nZ)(),l=d.value.find((t=>t.id===e)),s=a(e),{exportSVGElementForLevelTwo:c,exportSVGElementWithSize:u}=s;yield c({padding:{left:80,top:80,right:80,bottom:80},opaqueBackground:i,disableEmbedFonts:n,hasWatermark:t}).then((({svg:t,size:i})=>{o.push({sheetId:e,topicId:l.rootTopic.id,data:t.outerHTML,width:i.width,height:i.height})}));const h=[...l.rootTopic.children,...l.rootTopic.detachedChildren].filter((({id:e})=>F(e))).map((r=>u({padding:{left:80,top:80,right:80,bottom:80},scopeTopicId:r.id,opaqueBackground:i,disableEmbedFonts:n,hasWatermark:t}).then((({svg:t,size:i})=>{o.push({sheetId:e,topicId:r.id,data:t.outerHTML,width:i.width,height:i.height})}))));return yield Promise.all(h),o})),G=(e,t,i,n)=>C(void 0,void 0,void 0,(function*(){const{document:o,sheets:a}=(0,r.nZ)(),d=new v.Y8,l=(yield Promise.all(e.map((e=>B({sheetId:e,opaqueBackground:n,hasWatermark:i}))))).flat().map((e=>{const{topicId:t,sheetId:i}=e,n=a.value.find((({id:e})=>e===i)).title,r=o.value.query({id:t}).asTopic(),l=d.makeSafeName(`${n}_${r.title||""}`);return Object.assign(Object.assign({},e),{basename:l})}));if("svg"===t)return l.map((({basename:e,data:t})=>({data:t,filename:e+".svg"})));if("png"===t){const e=l.map((({data:e,width:t,height:i,basename:n})=>M({data:e,width:t,height:i}).then((e=>({data:Buffer.from(e.slice(22),"base64"),filename:n+".png"})))));return yield Promise.all(e)}})),M=e=>C(void 0,void 0,void 0,(function*(){const{data:t,width:i,height:n}=e,o=(new DOMParser).parseFromString(t,"image/svg+xml").firstChild;return yield w({width:i,height:n,scale:1,data:o})})),k=(e,t)=>C(void 0,void 0,void 0,(function*(){const i=e.map((({data:e,filename:i})=>{const n=s().join(t,i);(0,v.yS)(n,e)}));yield Promise.all(i)})),F=e=>{const{document:t}=(0,r.nZ)(),i=t.value.query({id:e}).asTopic(),n=i.children.length>0,o="folded"===i.branchState;return n&&!o};var Z=function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function a(e){try{l(n.next(e))}catch(e){r(e)}}function d(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,d)}l((n=n.apply(e,t||[])).next())}))};const W=(e="png",t={})=>Z(void 0,void 0,void 0,(function*(){const t=yield V(e);if(t){if("svg"===t.type&&(t.hasWatermark=!1),t.isSmartSplit)return i=t,C(void 0,void 0,void 0,(function*(){const{sheetSelection:e,type:t,hasWatermark:n,transparent:o}=i,{T:r}=(0,m.JE)(),{title:a}=(0,p.F)(),d=yield(0,T.eq)({folderName:null,dialogOptions:{buttonLabel:r("Save"),properties:["openDirectory","createDirectory"],securityScopedBookmarks:!0}});if(!d)return;const l=s().join(d,a);f.Z.existsSync(l)||f.Z.ensureDir(l),yield(0,v.Ae)(t);const c=yield G(e,t,n,!o);yield k(c,l),yield(0,v.Gm)(),u.shell.openPath(l)}));var i,n;if("png"===t.type)if(0===t.contentScope){const e=Date.now();yield(e=>S(void 0,void 0,void 0,(function*(){var t;const{hasWatermark:i,transparent:n,scale:o}=e,{activeSheet:a,activeSheetId:d}=(0,r.nZ)();yield(0,v.Ae)("png");const l=yield b(d.value,{hasWatermark:i,transparent:n,scale:o}),s=a.value.title,c=a.value.rootTopic.title,u=(0,g.N6)(null!==(t=null!=c?c:s)&&void 0!==t?t:"");yield(0,v.Gm)(),yield L(l,u)})))(t),(0,d.L9)({eventCategory:"export",eventAction:"durationExportPng",eventValue:Date.now()-e})}else yield(e=>S(void 0,void 0,void 0,(function*(){const{hasWatermark:t,transparent:i,scale:n}=e,{sheets:o}=(0,r.nZ)(),a=o.value.filter((t=>e.sheetSelection.includes(t.id)));yield(0,v.Ae)("png");const d=new v.Y8,l=yield Promise.all(a.map((e=>b(e.id,{hasWatermark:t,transparent:i,scale:n}).then((t=>{const i=e.title;return{fileData:t,fileName:d.makeSafeName(i)}})))));yield(0,v.Gm)(),yield O(l)})))(t);else"svg"===t.type&&(0===t.contentScope?yield(n=t.transparent,H(void 0,void 0,void 0,(function*(){var e;const{activeSheetId:t,activeSheet:i}=(0,r.nZ)();yield(0,v.Ae)("svg");const o=yield D(t.value,n),a=i.value.title,d=i.value.rootTopic.title,l=(0,g.N6)(null!==(e=null!=d?d:a)&&void 0!==e?e:"");yield(0,v.Gm)();const s=yield(0,T.ZZ)({title:"Export",suggestPath:{suggestedName:l},properties:["createDirectory"],filters:[{name:"SVG",extensions:["svg"]}]});s&&(yield(0,v.yS)(s,o),(0,m.Rg)().addRateMasValue(1),c.shell.showItemInFolder(s))}))):yield(e=>H(void 0,void 0,void 0,(function*(){yield(0,v.Ae)("svg"),yield(0,v.C7)();const{sheetSelection:t,transparent:i}=e,n=(0,m.JE)().T,{sheets:o}=(0,r.nZ)(),{title:a}=(0,p.F)(),d=(0,T.am)({});yield(0,v.Gm)();const{canceled:l,filePaths:h}=yield u.dialog.showOpenDialog((0,u.getCurrentWindow)(),{buttonLabel:n("Save"),properties:["openDirectory","createDirectory"],defaultPath:d,securityScopedBookmarks:!0});if(l||!h||!h.length)return;const g=s().join(h[0],a);f.Z.existsSync(g)||f.Z.ensureDir(g);const E=o.value.filter((e=>t.includes(e.id))),y=new v.Y8;Promise.all(E.map((e=>H(void 0,void 0,void 0,(function*(){const t=yield D(e.id,i),n=e.title,o=y.makeSafeName(n),r=s().join(g,o+".svg");return(0,v.yS)(r,t)}))))).then((()=>{c.shell.openPath(g)}))})))(t),(0,d.L9)({eventCategory:"export",eventAction:"exportSvg"}))}})),V=(e="png",t={})=>Z(void 0,void 0,void 0,(function*(){const{sheets:t,activeSheetFigure:i,activeSheetId:d,getSheetViewer:l}=(0,r.nZ)(),s=(0,o.hb)(),c=a.ZP.route((0,n.vN)(s),(({sheetId:e,opaqueBackground:t,hasWatermark:i})=>Z(void 0,void 0,void 0,(function*(){const n=l(e),o=yield n.exportSVGElement({opaqueBackground:t,disableEmbedFonts:!0,hasWatermark:i,padding:{top:50,left:50,right:50,bottom:i?120:50}});return{data:o.outerHTML,width:o.getAttribute("width"),height:o.getAttribute("height")}})))),u=a.ZP.route((0,n.Yo)(s,"export"),B),h=i.value.bounds,m=t.value.map((e=>e.id)),g=m.filter((e=>(e=>{var t,i;const{sheets:n}=(0,r.nZ)(),o=n.value.find((t=>t.id===e)),a=o.rootTopic,d=a.structureClass||(null===(i=null===(t=o.extensionBy("org.xmind.ui.skeleton.structure.style"))||void 0===t?void 0:t.content)||void 0===i?void 0:i.centralTopic);return![P.v.SPREADSHEET,P.v.COLUMNSPREADSHEET,P.v.TREETABLE,P.v.TOPTITLETREETABLE].includes(d)&&[...a.children,...a.detachedChildren].some((e=>F(e.id)))})(e))),p=t.value.map((e=>e.title)),{result:v}=yield a.ZP.fetch(n.Fx,{name:"dialog-export-to-image",parentId:window.id,wait:!0,query:{type:e,bound:[h.width,h.height],editorId:window.editorId,currentSheetId:d.value,routeId:s,sheetIds:m,sheetTitles:p,splitAbleSheetIds:g}});return c&&c(),u&&u(),v}))}}]);